<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Web Push Notification Teste</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        background-color: #1a237e;
        color: white;
        font-family: Arial, sans-serif;
        padding: 20px;
        text-align: center;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #45a049;
      }
      h1 {
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <h1>Web Push Notification</h1>
    <button id="subscribe">Ativar Notificações</button>
    <button id="send">Enviar Notificação</button>

    <script>
      const publicVapidKey = 'BIw1fNOqO_Kym2uEKEqojwO33twl1oN6S80EHKLaKjmSV1Aj1Newkdm9jmCCGkn2LjwTPTDgJ6r4p6APi6Z2bE0';

      // Configuração base do Axios
      const api = axios.create({
        baseURL: 'https://american-swipe-develop.up.railway.app',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      // Função para converter a chave pública
      function urlBase64ToUint8Array(base64String) {
        try {
          console.log('Convertendo chave pública:', base64String);
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          console.log('Chave convertida com sucesso');
          return outputArray;
        } catch (error) {
          console.error('Erro ao converter chave:', error);
          throw error;
        }
      }

      // Função para ativar as notificações
      async function subscribeUser() {
        try {
          if ('serviceWorker' in navigator) {
            console.log('Iniciando registro do Service Worker...');

            // Primeiro, vamos remover qualquer Service Worker existente
            const registrations = await navigator.serviceWorker.getRegistrations();
            for(let registration of registrations) {
              await registration.unregister();
            }
            console.log('Service Workers antigos removidos');

            // Agora vamos registrar o novo Service Worker
            const register = await navigator.serviceWorker.register('/web-push-teste/sw.js', {
              scope: '/web-push-teste/'
            });
            console.log('Service Worker registrado');

            // Aguardar o Service Worker estar ativo
            await navigator.serviceWorker.ready;
            console.log('Service Worker está ativo');

            // Verificar se o PushManager está disponível
            if (!register.pushManager) {
              throw new Error('Push Manager não está disponível');
            }

            console.log('Iniciando inscrição no Push Manager...');
            const applicationServerKey = urlBase64ToUint8Array(publicVapidKey);
            console.log('Chave do servidor convertida:', applicationServerKey);

            const subscription = await register.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: applicationServerKey
            });
            console.log('Inscrição realizada com sucesso:', subscription);

            const body = JSON.stringify({subscription});
            console.log('Enviando inscrição para o servidor...');
            const { data } = await api.post('/web-push', body);
            console.log('Resposta do servidor:', data);

            alert('Inscrito com sucesso para notificações!');
          } else {
            alert('Service Worker não suportado no navegador.');
          }
        } catch (error) {
          console.error('Erro detalhado:', error);
          const errorMessage = error.response?.data?.message || error.message;
          alert('Erro ao registrar notificações: ' + errorMessage);
        }
      }

      // Função para disparar notificação
      async function sendNotification() {
        try {
          const { data } = await api.post('/send-notification');
          console.log('Notificação enviada:', data);
          alert('Notificação enviada com sucesso!');
        } catch (error) {
          console.error('Erro ao enviar notificação:', error);
          const errorMessage = error.response?.data?.message || error.message;
          alert('Erro ao enviar notificação: ' + errorMessage);
        }
      }

      document.getElementById('subscribe').addEventListener('click', subscribeUser);
      document.getElementById('send').addEventListener('click', sendNotification);
    </script>
  </body>
</html>
